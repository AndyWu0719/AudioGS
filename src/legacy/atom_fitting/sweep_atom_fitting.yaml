# WandB Sweep Configuration for Atom Fitting Optimization
# ========================================================
# Flexible training with searchable densify_until_ratio and phase_weight.
# No hard-coded stages - let the data decide optimal boundaries.

program: scripts/sweeps/sweep_atom_fitting.py
method: bayes
metric:
  name: composite_score  # Quality - penalty for atom count
  goal: maximize

parameters:
  # --- 1. Iteration Count ---
  max_iters:
    distribution: int_uniform
    min: 6000
    max: 12000  # Aligned with config (12000 default)

  # --- 2. Density Control (FLEXIBLE) ---
  densify_from_iter:
    values: [300, 500]  # When to start densification
  
  densify_until_ratio:
    distribution: uniform
    min: 0.6
    max: 0.8   # Let data decide when to stop growing
  
  densification_interval:
    values: [100, 150]

  # --- 3. Atom Constraints ---
  initial_num_atoms:
    values: [2048, 4096]
  
  max_num_atoms:
    values: [4096, 6144, 8192, 10240, 12288, 16384]

  # --- 4. Learning Rates ---
  lr_amplitude:
    distribution: log_uniform_values
    min: 0.01
    max: 0.05
  
  lr_position:
    distribution: log_uniform_values
    min: 0.0005
    max: 0.005
  
  lr_frequency:
    distribution: log_uniform_values
    min: 0.001
    max: 0.02
  
  lr_sigma:
    distribution: log_uniform_values
    min: 0.005
    max: 0.03
  
  lr_phase:
    distribution: log_uniform_values
    min: 0.01
    max: 0.05

  # --- 5. Soft LR Decay (NEW) ---
  lr_decay_start_ratio:
    distribution: uniform
    min: 0.75
    max: 0.85
  
  lr_decay_factor:
    distribution: log_uniform_values
    min: 0.1
    max: 0.2

  # --- 6. Density Thresholds ---
  grad_threshold:
    distribution: log_uniform_values
    min: 0.0001
    max: 0.0005
  
  sigma_split_threshold:
    distribution: uniform
    min: 0.0025
    max: 0.0045
  
  prune_amplitude_threshold:
    distribution: log_uniform_values
    min: 0.0005
    max: 0.002

  # --- 7. Loss Weights ---
  spectral_weight:
    value: 1.0  # Fixed
  
  mel_weight:
    distribution: uniform
    min: 0.5
    max: 1.5
  
  time_domain_weight:
    distribution: uniform
    min: 0.05
    max: 0.2
  
  # NEW: Phase loss weight (crucial for PESQ > 3.0)
  phase_weight:
    distribution: uniform
    min: 0.5
    max: 1.5

# Early termination for poor runs
early_terminate:
  type: hyperband
  min_iter: 1000
  eta: 3
  s: 3

run_cap: 300